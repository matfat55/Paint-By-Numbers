Code taken from demonin and tweaked to add customization
